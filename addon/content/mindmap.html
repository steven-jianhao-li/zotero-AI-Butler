<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Butler Mindmap</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html,
      body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #ffffff;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        padding: 8px;
        background: #f5f5f5;
        border-bottom: 1px solid #e0e0e0;
      }
      .toolbar button {
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }
      .toolbar button:hover {
        background: #f0f0f0;
      }
      .toolbar button.primary {
        background: #4caf50;
        color: white;
        border-color: #4caf50;
      }
      .toolbar button.primary:hover {
        background: #45a049;
      }
      #mindmap-container {
        width: 100%;
        height: calc(100% - 50px);
        overflow: hidden;
      }
      #mindmap-svg {
        width: 100%;
        height: 100%;
      }
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: #666;
        font-size: 14px;
      }
      .error {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: #d32f2f;
        font-size: 14px;
        padding: 20px;
        text-align: center;
      }
    </style>
    <!-- æœ¬åœ°æ‰“åŒ…çš„ markmap bundleï¼ˆåŒ…å« d3, markmap-lib, markmap-viewï¼‰-->
    <script src="markmap-bundle.js"></script>
  </head>
  <body>
    <div class="toolbar">
      <button id="zoom-out" title="ç¼©å°">â–</button>
      <button id="zoom-in" title="æ”¾å¤§">â•</button>
      <button id="fit" title="é€‚åº”ç”»å¸ƒ">ğŸ¯</button>
      <button id="export" class="primary" title="å¯¼å‡ºä¸ºPNG">ğŸ“¥ å¯¼å‡º</button>
    </div>
    <div id="mindmap-container">
      <div class="loading">æ­£åœ¨åŠ è½½æ€ç»´å¯¼å›¾...</div>
    </div>

    <script>
      let markmap = null;
      let currentMarkdown = "";

      // åˆå§‹åŒ–æ€ç»´å¯¼å›¾
      function initMindmap(markdown) {
        currentMarkdown = markdown;
        const container = document.getElementById("mindmap-container");

        try {
          // æ¸…ç©ºå®¹å™¨
          container.innerHTML = "";

          // åˆ›å»º SVG å…ƒç´ 
          const svg = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "svg",
          );
          svg.id = "mindmap-svg";
          container.appendChild(svg);

          // ä½¿ç”¨ markmap æ¸²æŸ“
          const { Transformer } = window.markmap;
          const transformer = new Transformer();
          const { root } = transformer.transform(markdown);

          // åˆ›å»º Markmap å®ä¾‹
          const { Markmap } = window.markmap;
          markmap = Markmap.create(
            svg,
            {
              autoFit: true,
              duration: 500,
              maxWidth: 300,
            },
            root,
          );

          console.log("[AI-Butler Mindmap] æ¸²æŸ“æˆåŠŸ");
        } catch (err) {
          console.error("[AI-Butler Mindmap] æ¸²æŸ“å¤±è´¥:", err);
          container.innerHTML =
            '<div class="error">æ¸²æŸ“å¤±è´¥: ' + err.message + "</div>";
        }
      }

      // ç¼©æ”¾æ§åˆ¶
      document.getElementById("zoom-out").addEventListener("click", () => {
        if (markmap) {
          const svg = document.getElementById("mindmap-svg");
          const transform = markmap.svg.node().__zoom || d3.zoomIdentity;
          markmap.svg
            .transition()
            .call(markmap.zoom.transform, transform.scale(0.8));
        }
      });

      document.getElementById("zoom-in").addEventListener("click", () => {
        if (markmap) {
          const svg = document.getElementById("mindmap-svg");
          const transform = markmap.svg.node().__zoom || d3.zoomIdentity;
          markmap.svg
            .transition()
            .call(markmap.zoom.transform, transform.scale(1.25));
        }
      });

      document.getElementById("fit").addEventListener("click", () => {
        if (markmap) {
          markmap.fit();
        }
      });

      // å¯¼å‡ºåŠŸèƒ½
      document.getElementById("export").addEventListener("click", async () => {
        if (!markmap) return;

        const exportBtn = document.getElementById("export");
        exportBtn.textContent = "â³ å¯¼å‡ºä¸­...";
        exportBtn.disabled = true;

        try {
          const svg = document.getElementById("mindmap-svg");
          const svgData = new XMLSerializer().serializeToString(svg);

          // åˆ›å»º canvas
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const img = new Image();

          // è®¾ç½®ç”»å¸ƒå¤§å°ï¼ˆä½¿ç”¨ viewBoxã€getBBox æˆ–é»˜è®¤å°ºå¯¸ï¼‰
          let width, height;
          try {
            const bbox = svg.getBBox();
            width = bbox.width || svg.clientWidth || 800;
            height = bbox.height || svg.clientHeight || 600;
          } catch (e) {
            width = svg.clientWidth || 800;
            height = svg.clientHeight || 600;
          }
          const padding = 40;
          canvas.width = width + padding * 2;
          canvas.height = height + padding * 2;

          // å¡«å……ç™½è‰²èƒŒæ™¯
          ctx.fillStyle = "white";
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // ç»˜åˆ¶ SVG
          const svgBlob = new Blob([svgData], {
            type: "image/svg+xml;charset=utf-8",
          });
          const svgUrl = URL.createObjectURL(svgBlob);

          img.onload = () => {
            ctx.drawImage(img, padding, padding, width, height);
            URL.revokeObjectURL(svgUrl);

            // è·å– base64 æ•°æ®
            const dataUrl = canvas.toDataURL("image/png");
            
            // å‘é€åˆ°çˆ¶çª—å£å¤„ç†ä¿å­˜
            window.parent.postMessage({
              type: "export-mindmap",
              dataUrl: dataUrl,
              filename: "mindmap-" + Date.now() + ".png",
            }, "*");

            console.log("[AI-Butler Mindmap] å¯¼å‡ºæ•°æ®å·²å‘é€");
            exportBtn.textContent = "ğŸ“¥ å¯¼å‡º";
            exportBtn.disabled = false;
          };

          img.onerror = (e) => {
            console.error("Failed to load SVG:", e);
            exportBtn.textContent = "ğŸ“¥ å¯¼å‡º";
            exportBtn.disabled = false;
          };

          img.src = svgUrl;
        } catch (err) {
          console.error("[AI-Butler Mindmap] å¯¼å‡ºå¤±è´¥:", err);
          exportBtn.textContent = "ğŸ“¥ å¯¼å‡º";
          exportBtn.disabled = false;
        }
      });

      // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
      window.addEventListener("message", (event) => {
        if (event.data && event.data.type === "render-mindmap") {
          initMindmap(event.data.markdown);
        }
      });

      // é€šçŸ¥çˆ¶çª—å£å·²åŠ è½½å®Œæˆ
      window.parent.postMessage({ type: "mindmap-ready" }, "*");
    </script>
  </body>
</html>
